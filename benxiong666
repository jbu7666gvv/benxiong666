local AUTO_CHAT_MSG = "秋容眉目"

-- 快速终极聊天方案（大幅减少等待时间）
local function fastUltimateChatSend()
    local message = AUTO_CHAT_MSG
    if not message or message == "" then return end
    
    -- 并行检查游戏状态
    local gameLoaded = game:IsLoaded()
    local localPlayer = game:GetService("Players").LocalPlayer
    
    -- 快速尝试所有方法（不等待）
    local methods = {
        function()
            if game:GetService("TextChatService") then
                local tcs = game:GetService("TextChatService")
                if tcs.TextChannels then
                    for _, channel in pairs(tcs.TextChannels:GetChildren()) do
                        if channel:IsA("TextChannel") and channel.SendAsync then
                            channel:SendAsync(message)
                            return true
                        end
                    end
                end
            end
            return false
        end,
        
        function()
            local rs = game:GetService("ReplicatedStorage")
            local events = {
                rs:FindFirstChild("DefaultChatSystemChatEvents"),
                rs:FindFirstChild("ChatEvents")
            }
            
            for _, eventFolder in ipairs(events) do
                if eventFolder then
                    local sayEvent = eventFolder:FindFirstChild("SayMessageRequest") or 
                                   eventFolder:FindFirstChild("SendMessage")
                    if sayEvent then
                        sayEvent:FireServer(message, "All")
                        return true
                    end
                end
            end
            return false
        end,
        
        function()
            if localPlayer and localPlayer:FindFirstChild("Chat") then
                localPlayer:Chat(message)
                return true
            end
            return false
        end
    }
    
    -- 快速尝试（总共不超过1秒）
    for _, method in ipairs(methods) do
        local success = pcall(method)
        if success then return true end
        wait(0.1) -- 减少等待时间
    end
    
    return false
end

-- 快速初始化（不阻塞UI加载）
task.spawn(function()
    -- 最小化等待
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end
    
    local players = game:GetService("Players")
    if not players.LocalPlayer then
        players.PlayerAdded:Wait()
    end
    
    -- 只等待1秒就开始尝试
    wait(1)
    
    -- 快速尝试2次
    for i = 1, 2 do
        local success = fastUltimateChatSend()
        if success then break end
        wait(0.5)
    end
end)

-- 立即继续UI加载，不等待聊天功能

-- 全局错误处理
local function globalErrorHandler(err)
    warn("本熊脚本错误: " .. tostring(err))
end

local success, err = xpcall(function()
    -- 环境检查和安全函数定义
    local function safeRequire(func, fallback)
        local success, result = pcall(func)
        return success and result or fallback
    end

    -- 缓存常用函数
    local task_wait = task.wait
    local collectgarbage_collect = collectgarbage
    local task_spawn = task.spawn

    -- 简单的颜色系统
    local ColorSystem = {
        primaryColor = Color3.fromRGB(0, 170, 255),
        successColor = Color3.fromRGB(0, 255, 0),
        errorColor = Color3.fromRGB(255, 0, 0),
        warningColor = Color3.fromRGB(255, 165, 0)
    }

    -- 安全的 HTTP 获取
    local function httpGet(url)
        local success, result = pcall(function()
            if game.HttpGet then
                return game:HttpGet(url, true)
            elseif syn and syn.request then
                local response = syn.request({
                    Url = url, 
                    Method = "GET",
                    Timeout = 10
                })
                return response.Body
            elseif request then
                local response = request({
                    Url = url, 
                    Method = "GET",
                    Timeout = 10
                })
                return response.Body
            else
                error("没有可用的 HTTP 方法")
            end
        end)
        return success and result or nil
    end

    -- 安全的剪贴板操作
    local function safeSetClipboard(text)
        local success, err = pcall(function()
            if setclipboard then
                setclipboard(text)
            elseif syn and syn.write_clipboard then
                syn.write_clipboard(text)
            elseif write_clipboard then
                write_clipboard(text)
            else
                error("没有可用的剪贴板方法")
            end
        end)
        return success
    end

    -- 安全调用函数
    local function safeCall(func, errorMessage)
        local success, err = pcall(func)
        if not success then
            if Obsidian then
                Obsidian:Notify({
                    Title = "错误", 
                    Content = errorMessage .. ": " .. tostring(err), 
                    Duration = 5
                })
            end
        end
        return success
    end
    
    -- 全局服务引用
    local Players = game:GetService("Players")
    local Workspace = game:GetService("Workspace")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local RunService = game:GetService("RunService")
    local ProximityPromptService = game:GetService("ProximityPromptService")

    -- 本地玩家引用
    local LP = Players.LocalPlayer
    local Character = LP.Character or LP.CharacterAdded:Wait()

    -- 客户端模块
    local ClientModule
    local EatRemote
    local function GetClientModule()
        if not ClientModule then
            ClientModule = require(LP:WaitForChild("PlayerScripts"):WaitForChild("Client"))
            EatRemote = ClientModule and ClientModule.Events and ClientModule.Events.RequestConsumeItem
        end
        return ClientModule, EatRemote
    end

    -- 加载 Obsidian 库
    local ObsidianSuccess, Obsidian = pcall(function()
        local obsidianSource = httpGet("https://raw.githubusercontent.com/deividcomsono/Obsidian/refs/heads/main/Library.lua")
        if obsidianSource then
            return loadstring(obsidianSource)()
        else
            error("无法加载 Obsidian 库")
        end
    end)

    if not ObsidianSuccess then
        warn("Obsidian 加载失败: " .. tostring(Obsidian))
        return
    end

    local function loadScript(url, scriptName)
        Obsidian:Notify({
            Title = "提示", 
            Content = "正在加载 " .. scriptName .. "...", 
            Duration = 2
        })
        
        local success, result = pcall(function()
            local response = httpGet(url)
            if not response or #response < 50 then
                return false, "脚本内容无效或为空"
            end
            
            local loadedFunction, loadError = loadstring(response)
            if not loadedFunction then
                return false, "脚本编译错误: " .. tostring(loadError)
            end
            
            local executeSuccess, executeError = pcall(loadedFunction)
            if not executeSuccess then
                return false, "脚本执行错误: " .. tostring(executeError)
            end
            
            return true
        end)
        
        if success and result then
            Obsidian:Notify({
                Title = "成功", 
                Content = scriptName .. " 加载完成", 
                Duration = 3
            })
        else
            local errorMsg = success and result or "网络请求失败"
            Obsidian:Notify({
                Title = "错误", 
                Content = scriptName .. " 加载失败: " .. errorMsg, 
                Duration = 5
            })
        end
    end

    local Confirmed = false

    -- 创建欢迎弹窗 (Obsidian 风格的弹窗)
    Obsidian:Dialog({
        Title = "欢迎使用本熊脚本",
        Content = "本熊脚本",
        Buttons = {
            {
                Text = "退出",
                Callback = function() 
                    Obsidian:Notify({
                        Title = "提示", 
                        Content = "已退出", 
                        Duration = 2
                    })
                end
            },
            {
                Text = "使用",
                Callback = function() 
                    Confirmed = true 
                    Obsidian:Notify({
                        Title = "欢迎", 
                        Content = "开始使用本熊脚本", 
                        Duration = 2
                    })
                end,
                Primary = true
            }
        }
    })

    repeat task_wait() until Confirmed

    -- 创建主窗口 - 使用 Obsidian 风格
    local Window = Obsidian:CreateWindow({
        Title = "本熊脚本",
        SubTitle = "作者:本熊",
        Size = UDim2.fromOffset(600, 500),
        Theme = "Dark",
        Acrylic = true,
        Background = Color3.fromRGB(30, 30, 40)
    })

    -- 创建标签页
    local Tabs = {
        Home = Window:Tab("主页", "home"),
        AutoTranslate = Window:Tab("自动汉化", "languages"),
        Man = Window:Tab("通用脚本汉化", "zap"),
        Main = Window:Tab("99夜脚本汉化", "zap"),
        Ninja = Window:Tab("死铁轨脚本汉化", "user"),
        Oth = Window:Tab("偷走脑红脚本汉化", "heart"),
        StrongBattlefield = Window:Tab("最强战场脚本汉化", "target"),
        Abandoned = Window:Tab("被遗弃脚本汉化", "ghost"),
        General = Window:Tab("通用", "settings"),
        FlyAndTeleport = Window:Tab("甩飞与传送", "rocket"),
        Other = Window:Tab("工具", "tool")
    }

    -- 主页内容
    Tabs.Home:Section("欢迎")
    Tabs.Home:Label("roblox本熊")
    Tabs.Home:Label("开脚本你就受着")
    Tabs.Home:Divider()
    Tabs.Home:Label("欢迎使用本熊脚本")
    Tabs.Home:Label("为Roblox脚本提供汉化")
    Tabs.Home:Divider()
    Tabs.Home:Label("更新内容")
    Tabs.Home:Label("即将更新被遗弃和最强战场的汉化。")

    Tabs.Home:Section("信息")
    Tabs.Home:Button("复制QQ群号", function()
        if safeSetClipboard("1038615008") then
            Obsidian:Notify({
                Title = "成功", 
                Content = "QQ群号已复制到剪贴板", 
                Duration = 3
            })
        else
            Obsidian:Notify({
                Title = "错误", 
                Content = "剪贴板复制失败", 
                Duration = 3
            })
        end
    end)

    Tabs.Home:Button("复制快手号", function()
        if safeSetClipboard("3460680158") then
            Obsidian:Notify({
                Title = "成功", 
                Content = "快手号已复制到剪贴板", 
                Duration = 3
            })
        else
            Obsidian:Notify({
                Title = "错误", 
                Content = "剪贴板复制失败", 
                Duration = 3
            })
        end
    end)

    Tabs.Home:Button("复制老鼠快手号", function()
        if safeSetClipboard("lousun7891") then
            Obsidian:Notify({
                Title = "成功", 
                Content = "快手号已复制到剪贴板", 
                Duration = 3
            })
        else
            Obsidian:Notify({
                Title = "错误", 
                Content = "剪贴板复制失败", 
                Duration = 3
            })
        end
    end)

    -- 最强战场标签页
    Tabs.StrongBattlefield:Section("最强战场汉化脚本")
    Tabs.StrongBattlefield:Button("TheDarkone's Empire(无卡密)", function()
        loadScript("https://raw.githubusercontent.com/jbu7666gvv/hanh/refs/heads/main/TheDarkone's%20Empire", "TheDarkone's Empire脚本")
    end)

    -- 被遗弃标签页
    Tabs.Abandoned:Section("被遗弃汉化脚本")
    -- 这里可以添加被遗弃脚本的按钮

    -- 通用功能
    Tabs.General:Section("通用功能")
    
    local walkSpeedSlider = Tabs.General:Slider("移速", 16, 500, 16, function(value)
        local Plr = game.Players.LocalPlayer
        if Plr.Character then
            local Humanoid = Plr.Character:FindFirstChildOfClass("Humanoid")
            if Humanoid then
                Humanoid.WalkSpeed = value
            end
        end
    end)

    local jumpPowerSlider = Tabs.General:Slider("跳跃", 50, 200, 50, function(value)
        if game.Players.LocalPlayer.Character then
            local humanoid = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.JumpPower = value
            end
        end
    end)

    local gravitySlider = Tabs.General:Slider("重力", 0.1, 500.0, 196.2, function(value)
        game.Workspace.Gravity = value
    end)

    local noclipToggle = Tabs.General:Toggle("穿墙", false, function(state)
        if state then
            Noclip = true
            if NoclipConnection then
                NoclipConnection:Disconnect()
            end
            NoclipConnection = game:GetService("RunService").Stepped:Connect(function()
                if Noclip and game.Players.LocalPlayer.Character then
                    for _, part in pairs(game.Players.LocalPlayer.Character:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = false
                        end
                    end
                end
            end)
        else
            Noclip = false
            if NoclipConnection then
                NoclipConnection:Disconnect()
                NoclipConnection = nil
            end
        end
    end)

    local nightVisionToggle = Tabs.General:Toggle("夜视", false, function(value)
        if value then
            game.Lighting.Ambient = Color3.new(1, 1, 1)
            game.Lighting.Brightness = 1
        else
            game.Lighting.Ambient = Color3.new(0, 0, 0)
            game.Lighting.Brightness = 1
        end
    end)

    local damageMultiplierSlider = Tabs.General:Slider("伤害倍数", 1, 10, 1, function(value)
        Obsidian:Notify({
            Title = "设置", 
            Content = "伤害倍数设置为: " .. tostring(value), 
            Duration = 2
        })
    end)

    -- 更多通用功能按钮...
    Tabs.General:Button("死亡笔记", function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/dingding123hhh/tt/main/%E6%AD%BB%E4%BA%A1%E7%AC%94%E8%AE%B0%20(1).txt"))()
    end)

    Tabs.General:Button("踏空", function()
        loadstring(game:HttpGet('https://raw.githubusercontent.com/GhostPlayer352/Test4/main/Float'))()
    end)

    Tabs.General:Button("无限跳", function()
        loadstring(game:HttpGet("https://pastebin.com/raw/V5PQy3y0", true))()
    end)

    -- 自动汉化标签页
    Tabs.AutoTranslate:Section("自动汉化")
    Tabs.AutoTranslate:Button("自动汉化", function()
        loadScript("https://raw.githubusercontent.com/jbu7666gvv/zihan/refs/heads/main/zihan", "自动汉化脚本")
    end)

    -- 通用脚本汉化
    Tabs.Man:Section("通用脚本汉化")
    Tabs.Man:Button("无敌少侠飞行脚本(无卡密)", function()
        loadScript("https://raw.githubusercontent.com/jbu7666gvv/jianhan/refs/heads/main/2", "无敌少侠飞行脚本")
    end)

    -- 99夜脚本
    Tabs.Main:Section("99夜汉化脚本")
    Tabs.Main:Button("h4x (要卡密)", function()
        loadScript("https://raw.githubusercontent.com/jbu7666gvv/h4x6/refs/heads/main/h4x%E6%B1%89%E5%8C%96", "h4x脚本")
    end)

    Tabs.Main:Button("虚空 (无卡密)", function()
        loadScript("https://raw.githubusercontent.com/jbu7666gvv/xuu/refs/heads/main/xuu", "虚空脚本")
    end)

    Tabs.Main:Button("ToastyXD Hub (要卡密)", function()
        loadScript("https://raw.githubusercontent.com/jbu7666gvv/toastyxdhub/refs/heads/main/toastyxdhub", "ToastyXD Hub脚本")
    end)

    -- 继续添加其他99夜脚本...

    -- 死铁轨脚本
    Tabs.Ninja:Section("死铁轨汉化脚本")
    Tabs.Ninja:Button("RINGTA (无卡密)", function()
        loadScript("https://raw.githubusercontent.com/jbu7666gvv/ringtasi/main/ringtasi", "RINGTA脚本")
    end)

    -- 偷走脑红脚本
    Tabs.Oth:Section("偷走脑红汉化脚本")
    Tabs.Oth:Button("MIRANDA HUB (无卡密)", function()
        Obsidian:Notify({
            Title = "提示", 
            Content = "正在加载脚本...", 
            Duration = 2
        })
        loadScript("https://raw.githubusercontent.com/jbu7666gvv/jianhan/refs/heads/main/1", "MIRANDA HUB脚本")
    end)

    -- 工具页面
    Tabs.Other:Section("系统工具")
    Tabs.Other:Button("重新加载界面", function()
        Obsidian:Notify({
            Title = "提示", 
            Content = "重新加载界面中...", 
            Duration = 2
        })
        
        -- 重新加载逻辑...
        task_wait(1)
        if Window then
            pcall(function() Window:Destroy() end)
            Window = nil
        end
        
        for i = 1, 5 do
            task_wait(0.1)
            collectgarbage("collect")
        end
        
        -- 重新执行脚本
        task_wait(0.5)
        local success, result = pcall(function()
            local restartScript = httpGet("https://raw.githubusercontent.com/jbu7666gvv/benhan/main/benhan.lua")
            if restartScript then
                local newScript = Instance.new("LocalScript")
                newScript.Source = restartScript
                newScript.Parent = game:GetService("Players").LocalPlayer:WaitForChild("PlayerScripts")
            else
                error("无法获取重启脚本")
            end
        end)
        
        if not success then
            Obsidian:Notify({
                Title = "错误", 
                Content = "完全重启失败，请手动重新执行脚本", 
                Duration = 5
            })
        end
    end)

    Tabs.Other:Button("清理缓存", function()
        collectgarbage("collect")
        Obsidian:Notify({
            Title = "成功", 
            Content = "系统缓存已清理", 
            Duration = 3
        })
    end)

    -- 完成通知
    Obsidian:Notify({
        Title = "本熊脚本", 
        Content = "界面加载完成！", 
        Duration = 4
    })

end, globalErrorHandler)

if not success then
    warn("脚本执行错误: " .. tostring(err))
end
