-- ç¯å¢ƒæ£€æŸ¥å’Œå®‰å…¨å‡½æ•°å®šä¹‰
local function safeRequire(func, fallback)
    local success, result = pcall(func)
    return success and result or fallback
end

-- ç¼“å­˜å¸¸ç”¨å‡½æ•°
local task_wait = task.wait
local collectgarbage_collect = collectgarbage
local loadstring = loadstring or load

print("è„šæœ¬å¼€å§‹æ‰§è¡Œ...")

-- æ”¹è¿›çš„ HTTP è·å–å‡½æ•°
local function httpGet(url)
    print("å°è¯•HTTPè¯·æ±‚: " .. url)
    local success, result = pcall(function()
        -- æ–¹æ³•1: æ ‡å‡†HttpGet
        if game and game.HttpGet then
            print("ä½¿ç”¨ game:HttpGet")
            return game:HttpGet(url, true)
        -- æ–¹æ³•2: Synapse
        elseif syn and syn.request then
            print("ä½¿ç”¨ syn.request")
            local response = syn.request({
                Url = url,
                Method = "GET",
                Timeout = 10
            })
            return response.Body
        -- æ–¹æ³•3: KRNL/å…¶ä»–æ‰§è¡Œå™¨
        elseif request then
            print("ä½¿ç”¨ request")
            local response = request({
                Url = url,
                Method = "GET"
            })
            return response.Body
        -- æ–¹æ³•4: Fluxus
        elseif fluxus and fluxus.request then
            print("ä½¿ç”¨ fluxus.request")
            local response = fluxus.request({
                Url = url,
                Method = "GET"
            })
            return response.Body
        else
            print("æ²¡æœ‰å¯ç”¨çš„ HTTP æ–¹æ³•")
            error("æ²¡æœ‰å¯ç”¨çš„ HTTP æ–¹æ³•")
        end
    end)
    
    if success and result and #result > 100 then
        print("HTTPè¯·æ±‚æˆåŠŸï¼Œé•¿åº¦: " .. #result)
        return result
    else
        print("HTTPè¯·æ±‚å¤±è´¥: " .. tostring(result))
        return nil
    end
end

-- ç®€åŒ–çš„ WindUI åŠ è½½å‡½æ•°
local function loadWindUISafely()
    print("å¼€å§‹åŠ è½½ WindUI...")
    
    -- ä½¿ç”¨æ›´å¯é çš„æº
    local sources = {
        "https://raw.githubusercontent.com/Footagesus/WindUI/main/src/main.lua",
        "https://cdn.jsdelivr.net/gh/Footagesus/WindUI@main/src/main.lua",
    }
    
    for i, url in ipairs(sources) do
        print("å°è¯•æº " .. i .. ": " .. url)
        local source = httpGet(url)
        if source then
            print("æˆåŠŸè·å–æº " .. i .. ", é•¿åº¦: " .. #source)
            local success, lib = pcall(loadstring, source)
            if success and lib then
                print("WindUI åŠ è½½æˆåŠŸ")
                local ui = lib()
                if ui and ui.CreateWindow then
                    print("WindUI åŠŸèƒ½æ­£å¸¸")
                    return ui
                else
                    print("WindUI åŠŸèƒ½ä¸å®Œæ•´")
                end
            else
                print("WindUI ç¼–è¯‘å¤±è´¥: " .. tostring(lib))
            end
        else
            print("æº " .. i .. " è¯·æ±‚å¤±è´¥")
        end
        task_wait(1)
    end
    
    print("æ‰€æœ‰WindUIæºéƒ½å¤±è´¥")
    return nil
end

-- åŠ è½½ WindUI åº“
print("=== å¼€å§‹åŠ è½½UIåº“ ===")
local WindUISuccess, WindUI = pcall(loadWindUISafely)

if not WindUISuccess or not WindUI then
    print("WindUIåŠ è½½å¤±è´¥")
    -- ç›´æ¥ä½¿ç”¨æ¸¸æˆå†…ç½®é€šçŸ¥
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "æœ¬ç†Šæ±‰åŒ–",
        Text = "WindUIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",
        Duration = 5
    })
    return
else
    print("WindUIåŠ è½½æˆåŠŸ")
    WindUI:Notify({
        Title = "æœ¬ç†Šæ±‰åŒ–",
        Content = "WindUIåŠ è½½æˆåŠŸï¼",
        Duration = 3
    })
end

-- ç»™UIåº“åˆå§‹åŒ–æ—¶é—´
task_wait(1)

-- é¢œè‰²å¸¸é‡
local COLORS = {
    GRADIENT_START = Color3.fromHex("#00FF87"),
    GRADIENT_END = Color3.fromHex("#60EFFF"),
    BUTTON_START = Color3.fromHex("#FF0F7B"),
    BUTTON_END = Color3.fromHex("#F89B29")
}

-- å›¾æ ‡å¸¸é‡
local KEY_ICON = " ğŸ”‘"
local CHECK_ICON = " âœ…"

-- å®‰å…¨è°ƒç”¨å‡½æ•°
local function safeCall(func, errorMessage)
    local success, err = pcall(func)
    if not success then
        if WindUI then
            WindUI:Notify({Title = "é”™è¯¯", Content = errorMessage .. ": " .. tostring(err), Duration = 5})
        end
    end
    return success
end

-- å®‰å…¨çš„å‰ªè´´æ¿æ“ä½œ
local function safeSetClipboard(text)
    local success, err = pcall(function()
        if setclipboard then
            setclipboard(text)
        elseif syn and syn.write_clipboard then
            syn.write_clipboard(text)
        elseif write_clipboard then
            write_clipboard(text)
        else
            error("æ²¡æœ‰å¯ç”¨çš„å‰ªè´´æ¿æ–¹æ³•")
        end
    end)
    return success
end

-- å¯†é’¥éªŒè¯ç³»ç»Ÿï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥é€šè¿‡ï¼‰
local KeySystem = {
    ValidKeys = {"ç§‹å®¹", "æœ¬ç†Šæ±‰åŒ–", "WindUI"},
    CurrentKey = "ç§‹å®¹",
    IsValid = true
}

-- å®Œå…¨è·³è¿‡å¯†é’¥éªŒè¯
local function requireKeyOnStart()
    print("è·³è¿‡å¯†é’¥éªŒè¯")
    KeySystem.CurrentKey = "ç§‹å®¹"
    KeySystem.IsValid = true
    return true
end

-- åœ¨åˆ›å»ºä¸»çª—å£å‰éªŒè¯å¯†é’¥
print("=== å¼€å§‹å¯†é’¥éªŒè¯ ===")
local keyValid = requireKeyOnStart()
if not keyValid then
    WindUI:Notify({Title = "é”™è¯¯", Content = "å¯†é’¥éªŒè¯å¤±è´¥ï¼Œè„šæœ¬ç»ˆæ­¢", Duration = 5})
    print("å¯†é’¥éªŒè¯å¤±è´¥ï¼Œè„šæœ¬ç»ˆæ­¢")
    return
end

print("å¯†é’¥éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œä¸»ç•Œé¢...")

-- æ£€æŸ¥WindUIæ˜¯å¦çœŸçš„å¯ç”¨
print("=== æ£€æŸ¥UIåº“çŠ¶æ€ ===")
print("WindUIæ˜¯å¦å­˜åœ¨:", WindUI ~= nil)
print("WindUIç±»å‹:", type(WindUI))
print("CreateWindowæ–¹æ³•:", WindUI and type(WindUI.CreateWindow))

if not WindUI or not WindUI.CreateWindow then
    print("WindUIä¸å¯ç”¨")
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "é”™è¯¯",
        Text = "WindUIåŠŸèƒ½ä¸å®Œæ•´",
        Duration = 5
    })
    return
end

-- æµ‹è¯•é€šçŸ¥åŠŸèƒ½
if WindUI and WindUI.Notify then
    WindUI:Notify({
        Title = "è°ƒè¯•", 
        Content = "å¯†é’¥éªŒè¯é€šè¿‡ï¼Œå¼€å§‹åˆ›å»ºUI",
        Duration = 3
    })
else
    print("é”™è¯¯ï¼šWindUI.Notifyä¸å¯ç”¨")
    return
end

-- åˆ›å»ºä¸»çª—å£ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
local Window
local windowSuccess, windowError = pcall(function()
    Window = WindUI:CreateWindow({
        Title = "æœ¬ç†Šæ±‰åŒ–",
        Icon = "rbxassetid://129260712070622",
        IconThemed = true,
        Author = "æœ¬ç†Šæ±‰åŒ–",
        Folder = "æœ¬ç†Šæ±‰åŒ–",
        Size = UDim2.fromOffset(580, 460),
        Transparent = true,
        Theme = "Dark",
        User = {
            Enabled = true,
            Callback = function() 
                if safeSetClipboard("æœ¬ç†Šæ±‰åŒ–") then
                    WindUI:Notify({Title = "æç¤º", Content = "å·²å¤åˆ¶ä½œè€…ä¿¡æ¯", Duration = 2})
                else
                    WindUI:Notify({Title = "é”™è¯¯", Content = "å‰ªè´´æ¿å¤åˆ¶å¤±è´¥", Duration = 2})
                end
            end,
            Anonymous = true
        },
        SideBarWidth = 200,
        ScrollBarEnabled = true,
        KeySystem = false
    })
end)

if not windowSuccess or not Window then
    print("çª—å£åˆ›å»ºå¤±è´¥:", windowError)
    WindUI:Notify({
        Title = "é”™è¯¯", 
        Content = "çª—å£åˆ›å»ºå¤±è´¥: " .. tostring(windowError),
        Duration = 5
    })
    return
end

print("ä¸»çª—å£åˆ›å»ºæˆåŠŸ")

-- æ¸å˜æ–‡æœ¬å‡½æ•°
function gradient(text, startColor, endColor)
    local result = {}
    local length = #text
    
    for i = 1, length do
        local t = (i - 1) / math.max(length - 1, 1)
        local r = math.floor((startColor.R + (endColor.R - startColor.R) * t) * 255)
        local g = math.floor((startColor.G + (endColor.G - startColor.G) * t) * 255)
        local b = math.floor((startColor.B + (endColor.B - startColor.B) * t) * 255)
        
        table.insert(result, string.format('<font color="rgb(%d,%d,%d)">%s</font>', r, g, b, text:sub(i, i)))
    end
    
    return table.concat(result)
end

-- åŠ è½½è„šæœ¬å‡½æ•°
local function loadScript(url, scriptName)
    if not KeySystem.IsValid then
        WindUI:Notify({Title = "é”™è¯¯", Content = "å¯†é’¥å·²å¤±æ•ˆï¼Œè¯·é‡æ–°éªŒè¯", Duration = 3})
        return
    end
    
    WindUI:Notify({Title = "æç¤º", Content = "æ­£åœ¨åŠ è½½ " .. scriptName .. "...", Duration = 2})
    
    local success, result = pcall(function()
        local response = httpGet(url)
        if not response or #response < 50 then
            return false, "è„šæœ¬å†…å®¹æ— æ•ˆæˆ–ä¸ºç©º"
        end
        
        local loadedFunction, loadError = loadstring(response)
        if not loadedFunction then
            return false, "è„šæœ¬ç¼–è¯‘é”™è¯¯: " .. tostring(loadError)
        end
        
        local executeSuccess, executeError = pcall(loadedFunction)
        if not executeSuccess then
            return false, "è„šæœ¬æ‰§è¡Œé”™è¯¯: " .. tostring(executeError)
        end
        
        return true
    end)
    
    if success and result then
        WindUI:Notify({Title = "æˆåŠŸ", Content = scriptName .. " åŠ è½½å®Œæˆ", Duration = 3})
    else
        local errorMsg = success and result or "ç½‘ç»œè¯·æ±‚å¤±è´¥"
        WindUI:Notify({Title = "é”™è¯¯", Content = scriptName .. " åŠ è½½å¤±è´¥: " .. errorMsg, Duration = 5})
    end
end

-- æ¬¢è¿å¼¹çª—
print("æ˜¾ç¤ºæ¬¢è¿å¼¹çª—...")
local Confirmed = false

WindUI:Popup({
    Title = "æ¬¢è¿ä½¿ç”¨æœ¬ç†Šæ±‰åŒ–",
    Icon = "rbxassetid://112682688917044",
    IconThemed = true,
    Content = "æœ¬ç†Šæ±‰åŒ– WindUI Lib",  
    Buttons = {
        {
            Title = "é€€å‡º",
            Callback = function() 
                WindUI:Notify({Title = "æç¤º", Content = "å·²é€€å‡º", Duration = 2})
                Window:Destroy()
                return
            end,
            Variant = "Secondary",
        },
        {
            Title = "ä½¿ç”¨",
            Icon = "arrow-right",
            Callback = function() 
                Confirmed = true 
                WindUI:Notify({Title = "æ¬¢è¿", Content = "å¼€å§‹ä½¿ç”¨æœ¬ç†Šæ±‰åŒ–", Duration = 2})
            end,
            Variant = "Primary",
        }
    }
})

print("ç­‰å¾…ç”¨æˆ·ç¡®è®¤...")
-- ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼Œä½†è®¾ç½®è¶…æ—¶
local startTime = tick()
while not Confirmed do
    if tick() - startTime > 30 then -- 30ç§’è¶…æ—¶
        print("ç­‰å¾…ç¡®è®¤è¶…æ—¶ï¼Œè‡ªåŠ¨ç»§ç»­")
        Confirmed = true
    end
    task_wait(0.1)
end
print("ç”¨æˆ·ç¡®è®¤ï¼Œç»§ç»­åˆ›å»ºUI...")

-- æ·»åŠ é‡æ–°éªŒè¯æŒ‰é’®
Window:CreateTopbarButton("é‡æ–°éªŒè¯", "key", function() 
    KeySystem.IsValid = true
    WindUI:Notify({Title = "æˆåŠŸ", Content = "å¯†é’¥éªŒè¯é€šè¿‡ï¼", Duration = 3})
end, 990)

Window:CreateTopbarButton("å…¨å±", "battery-plus", function() 
    Window:ToggleFullscreen()
    WindUI:Notify({Title = "æç¤º", Content = "åˆ‡æ¢å…¨å±æ¨¡å¼", Duration = 2})
end, 989)

Window:EditOpenButton({
    Title = "æœ¬ç†Šæ±‰åŒ–",
    Icon = "monitor",
    CornerRadius = UDim.new(0,16),
    StrokeThickness = 2,
    Color = ColorSequence.new(COLORS.BUTTON_START, COLORS.BUTTON_END),
    Draggable = true,
})

print("åˆ›å»ºæ ‡ç­¾é¡µ...")
local Tabs = {
    Home = Window:Tab({ Title = "ä¸»é¡µ", Icon = "crown" }),
    Main = Window:Tab({ Title = "99å¤œ", Icon = "zap" }),
    Ninja = Window:Tab({ Title = "æ­»é“è½¨", Icon = "user" }),
    Oth = Window:Tab({ Title = "å·èµ°è„‘çº¢", Icon = "heart" }),
    Other = Window:Tab({ Title = "å·¥å…·", Icon = "settings" })
}

Window:SelectTab(1)

-- ä¸»é¡µå†…å®¹
Tabs.Home:Paragraph({
    Title = "æ¬¢è¿ä½¿ç”¨æœ¬ç†Šæ±‰åŒ–",
    Desc = "ä¸“ä¸ºRobloxè„šæœ¬æ±‰åŒ– - å¯†é’¥éªŒè¯ç³»ç»Ÿå·²å¯ç”¨",
})

Tabs.Home:Paragraph({
    Title = "æ›´æ–°å†…å®¹",
    Desc = "â€¢ å¢åŠ äº†å·èµ°è„‘çº¢æ±‰åŒ–ï¼Œä¼˜åŒ–äº†ç•Œé¢\nâ€¢ ç®€åŒ–äº†å¯†é’¥éªŒè¯æµç¨‹",
})

Tabs.Home:Section({Title = "ä¸»é¡µ"})

Tabs.Home:Button({
    Title = "å¤åˆ¶QQç¾¤å·",
    Callback = function()
        if safeSetClipboard("168985587") then
            WindUI:Notify({Title = "QQç¾¤å·", Content = "ç¾¤å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", Duration = 3})
        else
            WindUI:Notify({Title = "é”™è¯¯", Content = "å‰ªè´´æ¿å¤åˆ¶å¤±è´¥", Duration = 3})
        end
    end
})

Tabs.Home:Button({
    Title = "å¤åˆ¶è€é¼ å¿«æ‰‹å·",
    Callback = function()
        if safeSetClipboard("lousun7891") then
            WindUI:Notify({Title = "å¿«æ‰‹å·", Content = "å¿«æ‰‹å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", Duration = 3})
        else
            WindUI:Notify({Title = "é”™è¯¯", Content = "å‰ªè´´æ¿å¤åˆ¶å¤±è´¥", Duration = 3})
        end
    end
})

-- å…¶ä»–æ ‡ç­¾é¡µå†…å®¹
Tabs.Main:Section({Title = "99å¤œè„šæœ¬"})
Tabs.Main:Button({
    Title = "åŠ è½½99å¤œæ±‰åŒ–",
    Callback = function()
        WindUI:Notify({Title = "æç¤º", Content = "åŠ è½½99å¤œæ±‰åŒ–è„šæœ¬...", Duration = 3})
        -- è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„è„šæœ¬åŠ è½½ä»£ç 
    end
})

Tabs.Ninja:Section({Title = "æ­»é“è½¨è„šæœ¬"})
Tabs.Ninja:Button({
    Title = "åŠ è½½æ­»é“è½¨æ±‰åŒ–",
    Callback = function()
        WindUI:Notify({Title = "æç¤º", Content = "åŠ è½½æ­»é“è½¨æ±‰åŒ–è„šæœ¬...", Duration = 3})
        -- è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„è„šæœ¬åŠ è½½ä»£ç 
    end
})

Tabs.Oth:Section({Title = "å·èµ°è„‘çº¢è„šæœ¬"})
Tabs.Oth:Button({
    Title = "åŠ è½½å·èµ°è„‘çº¢æ±‰åŒ–",
    Callback = function()
        WindUI:Notify({Title = "æç¤º", Content = "åŠ è½½å·èµ°è„‘çº¢æ±‰åŒ–è„šæœ¬...", Duration = 3})
        -- è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„è„šæœ¬åŠ è½½ä»£ç 
    end
})

Tabs.Other:Section({Title = "å·¥å…·"})
Tabs.Other:Button({
    Title = "æ¸…ç†å†…å­˜",
    Callback = function()
        collectgarbage_collect()
        WindUI:Notify({Title = "æç¤º", Content = "å†…å­˜æ¸…ç†å®Œæˆ", Duration = 2})
    end
})

Tabs.Other:Button({
    Title = "æ˜¾ç¤ºä¿¡æ¯",
    Callback = function()
        WindUI:Notify({
            Title = "ç³»ç»Ÿä¿¡æ¯", 
            Content = "æœ¬ç†Šæ±‰åŒ– - WindUIæ¨¡å¼\nå¯†é’¥çŠ¶æ€: éªŒè¯é€šè¿‡\nå½“å‰å¯†é’¥: " .. KeySystem.CurrentKey,
            Duration = 5
        })
    end
})

print("ç•Œé¢åˆ›å»ºå®Œæˆï¼Œæ˜¾ç¤ºæˆåŠŸé€šçŸ¥")
WindUI:Notify({
    Title = "æœ¬ç†Šæ±‰åŒ–", 
    Content = "ç•Œé¢åŠ è½½å®Œæˆï¼å¯†é’¥éªŒè¯é€šè¿‡ï¼Œè¯·é€‰æ‹©éœ€è¦çš„è„šæœ¬ã€‚",
    Duration = 4
})

print("=== è„šæœ¬æ‰§è¡Œå®Œæˆ ===")
