-- Robloxè‡ªåŠ¨æ€§èƒ½æµ‹è¯•è„šæœ¬
-- æ”¾åœ¨ServerScriptServiceä¸­

local ServerScriptService = game:GetService("ServerScriptService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- è‡ªåŠ¨æ€§èƒ½æµ‹è¯•å™¨
local AutoPerformanceTester = {}

-- å¸§ç‡æ˜¾ç¤ºå™¨
local FPSMonitor = {}
FPSMonitor.__index = FPSMonitor

function FPSMonitor.new()
	local self = setmetatable({}, FPSMonitor)
	self.frameCount = 0
	self.lastTime = tick()
	self.currentFPS = 0
	self.connection = nil
	return self
end

function FPSMonitor:Start()
	self.connection = RunService.Heartbeat:Connect(function()
		self.frameCount = self.frameCount + 1
		local currentTime = tick()
		local elapsed = currentTime - self.lastTime
		
		if elapsed >= 1 then
			self.currentFPS = math.floor(self.frameCount / elapsed)
			self.frameCount = 0
			self.lastTime = currentTime
		end
	end)
end

function FPSMonitor:Stop()
	if self.connection then
		self.connection:Disconnect()
		self.connection = nil
	end
end

function FPSMonitor:GetFPS()
	return self.currentFPS
end

-- è‡ªåŠ¨å¼€å§‹æ€§èƒ½æµ‹è¯•
function AutoPerformanceTester:StartAutoTest()
	print("=== Robloxæ€§èƒ½æµ‹è¯•å¼€å§‹ ===")
	print("æµ‹è¯•ç±»å‹: " .. self.testType)
	print("æµ‹è¯•å¼ºåº¦: " .. self.intensity)
	
	-- ä¸ºæ‰€æœ‰ç©å®¶å¯åŠ¨æµ‹è¯•
	Players.PlayerAdded:Connect(function(player)
		self:SetupPlayerTest(player)
	end)
	
	-- ä¸ºå·²è¿æ¥çš„ç©å®¶å¯åŠ¨æµ‹è¯•
	for _, player in ipairs(Players:GetPlayers()) do
		self:SetupPlayerTest(player)
	end
end

-- è®¾ç½®ç©å®¶æµ‹è¯•
function AutoPerformanceTester:SetupPlayerTest(player)
	-- ä¸ºç©å®¶åˆ›å»ºFPSæ˜¾ç¤ºå™¨
	if not player:FindFirstChild("FPSMonitor") then
		local folder = Instance.new("Folder")
		folder.Name = "FPSMonitor"
		folder.Parent = player
		
		local fpsMonitor = FPSMonitor.new()
		fpsMonitor:Start()
		folder:SetAttribute("FPSMonitor", fpsMonitor)
	end
	
	-- æ¸…ç†ä¹‹å‰çš„æµ‹è¯•
	self:CleanupTest(player)
	
	-- åˆ›å»ºæµ‹è¯•å®¹å™¨
	local testFolder = Instance.new("Folder")
	testFolder.Name = "PerformanceTest"
	testFolder.Parent = player
	
	-- æ ¹æ®æµ‹è¯•ç±»å‹æ‰§è¡Œä¸åŒçš„æ€§èƒ½æµ‹è¯•
	if self.testType == "parts" then
		self:CreatePartsTest(testFolder, self.intensity)
	elseif self.testType == "scripts" then
		self:CreateScriptsTest(testFolder, self.intensity)
	elseif self.testType == "lights" then
		self:CreateLightsTest(testFolder, self.intensity)
	elseif self.testType == "particles" then
		self:CreateParticlesTest(testFolder, self.intensity)
	elseif self.testType == "mixed" then
		self:CreateMixedTest(testFolder, self.intensity)
	end
	
	-- å¼€å§‹ç›‘æ§æ€§èƒ½
	self:StartPerformanceMonitoring(player)
	
	print("ç©å®¶ " .. player.Name .. " çš„æ€§èƒ½æµ‹è¯•å·²å¯åŠ¨")
end

-- åˆ›å»ºå¤§é‡é›¶ä»¶æµ‹è¯•
function AutoPerformanceTester:CreatePartsTest(folder, intensity)
	local partCount = 100 * intensity
	
	print("ç”Ÿæˆ " .. partCount .. " ä¸ªæµ‹è¯•é›¶ä»¶...")
	
	for i = 1, partCount do
		local part = Instance.new("Part")
		part.Name = "TestPart_" .. i
		part.Size = Vector3.new(4, 4, 4)
		part.Position = Vector3.new(
			math.random(-50, 50) * intensity,
			math.random(10, 50) * intensity,
			math.random(-50, 50) * intensity
		)
		part.Anchored = false
		part.CanCollide = true
		part.Material = Enum.Material.Neon
		part.BrickColor = BrickColor.random()
		part.Parent = folder
		
		-- æ·»åŠ ç‰©ç†æ•ˆæœ
		local bodyForce = Instance.new("BodyForce")
		bodyForce.Force = Vector3.new(0, part:GetMass() * 196.2, 0)
		bodyForce.Parent = part
		
		-- æ·»åŠ ä¸€äº›è§†è§‰æ•ˆæœ
		if i % 10 == 0 then
			local sparkles = Instance.new("Sparkles")
			sparkles.SparkleColor = Color3.new(math.random(), math.random(), math.random())
			sparkles.Parent = part
		end
	end
end

-- åˆ›å»ºè„šæœ¬æµ‹è¯•
function AutoPerformanceTester:CreateScriptsTest(folder, intensity)
	local scriptCount = 50 * intensity
	
	print("ç”Ÿæˆ " .. scriptCount .. " ä¸ªæµ‹è¯•è„šæœ¬...")
	
	for i = 1, scriptCount do
		local script = Instance.new("Script")
		script.Name = "TestScript_" .. i
		
		-- åˆ›å»ºé«˜é¢‘ç‡è¿è¡Œçš„è„šæœ¬
		local source = [[
			local RunService = game:GetService("RunService")
			local startTime = tick()
			local counter = 0
			
			while true do
				counter = counter + 1
				-- æ¨¡æ‹Ÿä¸€äº›è®¡ç®—å¯†é›†å‹æ“ä½œ
				local result = 0
				for j = 1, 500 do
					result = result + math.sin(j * 0.1) * math.cos(j * 0.1)
				end
				
				-- åˆ›å»ºä¸€äº›ä¸´æ—¶è¡¨æ¥å¢åŠ å†…å­˜å‹åŠ›
				local tempTable = {}
				for k = 1, 100 do
					tempTable[k] = math.random(1, 1000)
				end
				
				if tick() - startTime > 0.05 then
					break
				end
				RunService.Heartbeat:Wait()
			end
		]]
		
		script.Source = source
		script.Parent = folder
		script.Disabled = false
	end
end

-- åˆ›å»ºç¯å…‰æµ‹è¯•
function AutoPerformanceTester:CreateLightsTest(folder, intensity)
	local lightCount = 20 * intensity
	
	print("ç”Ÿæˆ " .. lightCount .. " ä¸ªæµ‹è¯•ç¯å…‰...")
	
	for i = 1, lightCount do
		local part = Instance.new("Part")
		part.Name = "LightPart_" .. i
		part.Size = Vector3.new(2, 2, 2)
		part.Position = Vector3.new(
			math.random(-30, 30) * intensity,
			math.random(5, 20),
			math.random(-30, 30) * intensity
		)
		part.Anchored = true
		part.Material = Enum.Material.Neon
		part.BrickColor = BrickColor.random()
		
		local pointLight = Instance.new("PointLight")
		pointLight.Brightness = 5 * intensity
		pointLight.Range = 20
		pointLight.Color = Color3.new(math.random(), math.random(), math.random())
		pointLight.Parent = part
		
		-- æ·»åŠ é—ªçƒæ•ˆæœ
		if i % 5 == 0 then
			local flickerScript = Instance.new("Script")
			flickerScript.Source = [[
				local light = script.Parent.PointLight
				while true do
					light.Brightness = math.random(3, 8)
					wait(math.random(0.1, 0.5))
				end
			]]
			flickerScript.Parent = part
		end
		
		part.Parent = folder
	end
end

-- åˆ›å»ºç²’å­æ•ˆæœæµ‹è¯•
function AutoPerformanceTester:CreateParticlesTest(folder, intensity)
	local emitterCount = 10 * intensity
	
	print("ç”Ÿæˆ " .. emitterCount .. " ä¸ªç²’å­å‘å°„å™¨...")
	
	for i = 1, emitterCount do
		local part = Instance.new("Part")
		part.Name = "ParticleEmitter_" .. i
		part.Size = Vector3.new(1, 1, 1)
		part.Position = Vector3.new(
			math.random(-20, 20) * intensity,
			math.random(5, 15),
			math.random(-20, 20) * intensity
		)
		part.Anchored = true
		part.Transparency = 1
		
		local particleEmitter = Instance.new("ParticleEmitter")
		particleEmitter.Rate = 100 * intensity
		particleEmitter.Speed = NumberRange.new(5, 10)
		particleEmitter.Size = NumberSequence.new({
			NumberSequenceKeypoint.new(0, 0.5),
			NumberSequenceKeypoint.new(1, 0)
		})
		particleEmitter.Lifetime = NumberRange.new(1, 3)
		particleEmitter.Color = ColorSequence.new(Color3.new(math.random(), math.random(), math.random()))
		particleEmitter.Parent = part
		
		part.Parent = folder
	end
end

-- åˆ›å»ºæ··åˆæµ‹è¯•
function AutoPerformanceTester:CreateMixedTest(folder, intensity)
	print("å¼€å§‹æ··åˆæ€§èƒ½æµ‹è¯•...")
	self:CreatePartsTest(folder, intensity * 0.5)
	self:CreateScriptsTest(folder, intensity * 0.3)
	self:CreateLightsTest(folder, intensity * 0.4)
	self:CreateParticlesTest(folder, intensity * 0.3)
end

-- å¼€å§‹æ€§èƒ½ç›‘æ§
function AutoPerformanceTester:StartPerformanceMonitoring(player)
	local fpsMonitor = player.FPSMonitor:GetAttribute("FPSMonitor")
	
	local monitorScript = Instance.new("LocalScript")
	monitorScript.Name = "PerformanceMonitor"
	
	local source = [[
		local Players = game:GetService("Players")
		local RunService = game:GetService("RunService")
		local Stats = game:GetService("Stats")
		local player = Players.LocalPlayer
		
		-- åˆ›å»ºæ˜¾ç¤ºUI
		local screenGui = Instance.new("ScreenGui")
		screenGui.Name = "PerformanceDisplay"
		screenGui.Parent = player.PlayerGui
		screenGui.DisplayOrder = 999
		
		local frame = Instance.new("Frame")
		frame.Size = UDim2.new(0, 250, 0, 150)
		frame.Position = UDim2.new(0, 10, 0, 10)
		frame.BackgroundColor3 = Color3.new(0, 0, 0)
		frame.BackgroundTransparency = 0.3
		frame.BorderSizePixel = 0
		frame.Parent = screenGui
		
		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(0, 8)
		corner.Parent = frame
		
		local padding = Instance.new("UIPadding")
		padding.PaddingLeft = UDim.new(0, 15)
		padding.PaddingTop = UDim.new(0, 15)
		padding.Parent = frame
		
		local title = Instance.new("TextLabel")
		title.Size = UDim2.new(1, 0, 0, 20)
		title.Position = UDim2.new(0, 0, 0, 0)
		title.BackgroundTransparency = 1
		title.Text = "ğŸ”§ æ€§èƒ½æµ‹è¯•ç›‘æ§"
		title.TextColor3 = Color3.new(1, 1, 0)
		title.TextSize = 16
		title.TextXAlignment = Enum.TextXAlignment.Left
		title.Font = Enum.Font.GothamBold
		title.Parent = frame
		
		local fpsLabel = Instance.new("TextLabel")
		fpsLabel.Size = UDim2.new(1, 0, 0, 20)
		fpsLabel.Position = UDim2.new(0, 0, 0, 25)
		fpsLabel.BackgroundTransparency = 1
		fpsLabel.Text = "ğŸ® FPS: --"
		fpsLabel.TextColor3 = Color3.new(0.5, 1, 0.5)
		fpsLabel.TextSize = 14
		fpsLabel.TextXAlignment = Enum.TextXAlignment.Left
		fpsLabel.Parent = frame
		
		local memoryLabel = Instance.new("TextLabel")
		memoryLabel.Size = UDim2.new(1, 0, 0, 20)
		memoryLabel.Position = UDim2.new(0, 0, 0, 50)
		memoryLabel.BackgroundTransparency = 1
		memoryLabel.Text = "ğŸ’¾ å†…å­˜: --"
		memoryLabel.TextColor3 = Color3.new(0.5, 0.8, 1)
		memoryLabel.TextSize = 14
		memoryLabel.TextXAlignment = Enum.TextXAlignment.Left
		memoryLabel.Parent = frame
		
		local pingLabel = Instance.new("TextLabel")
		pingLabel.Size = UDim2.new(1, 0, 0, 20)
		pingLabel.Position = UDim2.new(0, 0, 0, 75)
		pingLabel.BackgroundTransparency = 1
		pingLabel.Text = "ğŸ“¡ Ping: --"
		pingLabel.TextColor3 = Color3.new(1, 0.8, 0.5)
		pingLabel.TextSize = 14
		pingLabel.TextXAlignment = Enum.TextXAlignment.Left
		pingLabel.Parent = frame
		
		local statusLabel = Instance.new("TextLabel")
		statusLabel.Size = UDim2.new(1, 0, 0, 20)
		statusLabel.Position = UDim2.new(0, 0, 0, 100)
		statusLabel.BackgroundTransparency = 1
		statusLabel.Text = "âœ… æµ‹è¯•è¿è¡Œä¸­"
		statusLabel.TextColor3 = Color3.new(1, 1, 1)
		statusLabel.TextSize = 14
		statusLabel.TextXAlignment = Enum.TextXAlignment.Left
		statusLabel.Parent = frame
		
		-- é¢œè‰²æ ¹æ®FPSå€¼å˜åŒ–
		local function getFPSColor(fps)
			if fps >= 60 then
				return Color3.new(0, 1, 0)  -- ç»¿è‰²
			elseif fps >= 30 then
				return Color3.new(1, 1, 0)  -- é»„è‰²
			else
				return Color3.new(1, 0, 0)  -- çº¢è‰²
			end
		end
		
		-- æ›´æ–°æ˜¾ç¤º
		local frameCount = 0
		local lastUpdate = tick()
		
		while true do
			frameCount = frameCount + 1
			
			-- æ¯ç§’æ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
			if tick() - lastUpdate >= 0.5 then
				local fpsMonitor = player:FindFirstChild("FPSMonitor")
				if fpsMonitor then
					local monitor = fpsMonitor:GetAttribute("FPSMonitor")
					if monitor then
						local fps = monitor:GetFPS()
						fpsLabel.Text = "ğŸ® FPS: " .. tostring(fps)
						fpsLabel.TextColor3 = getFPSColor(fps)
					end
				end
				
				-- è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
				local memory = collectgarbage("count")
				memoryLabel.Text = string.format("ğŸ’¾ å†…å­˜: %.1f MB", memory / 1024)
				
				-- è·å–ç½‘ç»œç»Ÿè®¡
				local stats = Stats:FindFirstChild("PerformanceStats")
				if stats then
					local ping = stats:FindFirstChild("Ping")
					if ping then
						pingLabel.Text = "ğŸ“¡ Ping: " .. string.format("%.0f", ping.Value) .. "ms"
					end
				end
				
				lastUpdate = tick()
			end
			
			RunService.Heartbeat:Wait()
		end
	]]
	
	monitorScript.Source = source
	monitorScript.Parent = player
end

-- æ¸…ç†æµ‹è¯•
function AutoPerformanceTester:CleanupTest(player)
	local testFolder = player:FindFirstChild("PerformanceTest")
	if testFolder then
		testFolder:Destroy()
	end
	
	local monitorScript = player:FindFirstChild("PerformanceMonitor")
	if monitorScript then
		monitorScript:Destroy()
	end
	
	local screenGui = player.PlayerGui:FindFirstChild("PerformanceDisplay")
	if screenGui then
		screenGui:Destroy()
	end
end

-- åœæ­¢æ‰€æœ‰æµ‹è¯•
function AutoPerformanceTester:StopAllTests()
	print("=== åœæ­¢æ‰€æœ‰æ€§èƒ½æµ‹è¯• ===")
	
	for _, player in ipairs(Players:GetPlayers()) do
		self:CleanupTest(player)
		
		local fpsFolder = player:FindFirstChild("FPSMonitor")
		if fpsFolder then
			local fpsMonitor = fpsFolder:GetAttribute("FPSMonitor")
			if fpsMonitor then
				fpsMonitor:Stop()
			end
			fpsFolder:Destroy()
		end
	end
end

-- é…ç½®æµ‹è¯•å‚æ•°ï¼ˆåœ¨è¿™é‡Œä¿®æ”¹æµ‹è¯•ç±»å‹å’Œå¼ºåº¦ï¼‰
AutoPerformanceTester.testType = "mixed"
AutoPerformanceTester.intensity = 5

-- å»¶è¿Ÿä¸€æ®µæ—¶é—´åè‡ªåŠ¨å¼€å§‹æµ‹è¯•ï¼ˆç¡®ä¿æ¸¸æˆå®Œå…¨åŠ è½½ï¼‰
wait(1)

-- è‡ªåŠ¨å¼€å§‹æ€§èƒ½æµ‹è¯•
AutoPerformanceTester:StartAutoTest()

wait(1000)
AutoPerformanceTester:StopAllTests()

print("ç­‰ç€å¡çˆ†å§ï¼Œå­©å­")
print("ç­‰ç€å¡çˆ†å§ï¼Œå­©å­")

return AutoPerformanceTester
